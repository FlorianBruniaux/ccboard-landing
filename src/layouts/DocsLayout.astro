---
import Layout from './Layout.astro'
import { navigation, getPagination } from '../utils/navigation'

interface Props {
  title: string
  description?: string
  headings?: { depth: number; slug: string; text: string }[]
}

const { title, description, headings = [] } = Astro.props
const currentPath = Astro.url.pathname
const { prev, next } = getPagination(currentPath)

// Build breadcrumb from path
const segments = currentPath.split('/').filter(Boolean)
const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Docs', href: '/docs/getting-started/' },
  ...(segments.length > 2
    ? [{ label: title, href: currentPath }]
    : [{ label: title, href: currentPath }]),
]

const tocItems = headings.filter(h => h.depth >= 2 && h.depth <= 3)
---

<Layout title={`${title} - ccboard Docs`} description={description}>
  <div class="docs-wrapper">
    <!-- Sidebar -->
    <aside class="docs-sidebar" id="docs-sidebar">
      <nav class="sidebar-nav" aria-label="Documentation">
        {navigation.map(section => (
          <div class="sidebar-section">
            <h3 class="sidebar-heading">{section.title}</h3>
            <ul class="sidebar-list">
              {section.items.map(item => (
                <li>
                  <a
                    href={item.href}
                    class:list={['sidebar-link', { active: currentPath === item.href }]}
                  >
                    {item.title}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ))}
      </nav>
    </aside>

    <!-- Main content -->
    <main class="docs-content">
      <!-- Breadcrumbs -->
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        {breadcrumbs.map((crumb, i) => (
          <>
            {i > 0 && <span class="breadcrumb-sep">/</span>}
            {i === breadcrumbs.length - 1 ? (
              <span class="breadcrumb-current">{crumb.label}</span>
            ) : (
              <a href={crumb.href} class="breadcrumb-link">{crumb.label}</a>
            )}
          </>
        ))}
      </nav>

      <h1 class="docs-title">{title}</h1>

      <article class="prose" data-pagefind-body>
        <slot />
      </article>

      <!-- Pagination -->
      <nav class="docs-pagination" aria-label="Page navigation">
        {prev ? (
          <a href={prev.href} class="pagination-link prev">
            <span class="pagination-label">Previous</span>
            <span class="pagination-title">{prev.title}</span>
          </a>
        ) : <div />}
        {next ? (
          <a href={next.href} class="pagination-link next">
            <span class="pagination-label">Next</span>
            <span class="pagination-title">{next.title}</span>
          </a>
        ) : <div />}
      </nav>
    </main>

    <!-- Table of Contents -->
    {tocItems.length > 0 && (
      <aside class="docs-toc">
        <h4 class="toc-heading">On this page</h4>
        <nav aria-label="Table of contents">
          <ul class="toc-list">
            {tocItems.map(h => (
              <li class:list={[h.depth === 3 && 'toc-indent']}>
                <a href={`#${h.slug}`} class="toc-link">{h.text}</a>
              </li>
            ))}
          </ul>
        </nav>
      </aside>
    )}
  </div>

  <!-- Mobile sidebar toggle -->
  <button
    id="sidebar-toggle"
    class="sidebar-toggle"
    aria-label="Toggle sidebar"
    aria-expanded="false"
  >
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 12h18M3 6h18M3 18h18" />
    </svg>
  </button>
</Layout>

<style>
  .docs-wrapper {
    display: grid;
    grid-template-columns: 240px 1fr 200px;
    max-width: 1200px;
    margin: 0 auto;
    padding-top: 5rem;
    min-height: 100vh;
  }

  /* Sidebar */
  .docs-sidebar {
    position: sticky;
    top: 5rem;
    height: calc(100vh - 5rem);
    overflow-y: auto;
    padding: 1.5rem 1rem;
    border-right: 1px solid var(--border);
  }

  .sidebar-heading {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
    margin-top: 1.25rem;
  }

  .sidebar-section:first-child .sidebar-heading {
    margin-top: 0;
  }

  .sidebar-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sidebar-link {
    display: block;
    padding: 0.3rem 0.75rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.15s;
  }

  .sidebar-link:hover {
    color: var(--text-primary);
    background: var(--bg-secondary);
  }

  .sidebar-link.active {
    color: var(--accent);
    background: rgba(249, 115, 22, 0.1);
    font-weight: 500;
  }

  /* Content */
  .docs-content {
    padding: 1.5rem 2rem;
    min-width: 0;
    max-width: 800px;
  }

  .breadcrumbs {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    margin-bottom: 1rem;
  }

  .breadcrumb-link {
    color: var(--text-muted);
    text-decoration: none;
  }

  .breadcrumb-link:hover {
    color: var(--accent);
  }

  .breadcrumb-sep {
    color: var(--text-muted);
  }

  .breadcrumb-current {
    color: var(--text-secondary);
  }

  .docs-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
  }

  /* Prose */
  .prose {
    font-size: 0.95rem;
    line-height: 1.7;
    color: var(--text-secondary);
  }

  .prose :global(h2) {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }

  .prose :global(h3) {
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .prose :global(p) {
    margin-bottom: 1rem;
  }

  .prose :global(code) {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    padding: 0.1em 0.4em;
    border-radius: 4px;
    font-size: 0.88em;
    font-family: var(--font-mono, 'JetBrains Mono', monospace);
  }

  .prose :global(code::before),
  .prose :global(code::after) {
    content: none !important;
  }

  .prose :global(pre) {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    overflow-x: auto;
    margin: 1rem 0;
    font-size: 0.85rem;
  }

  .prose :global(pre code) {
    background: none;
    padding: 0;
  }

  .prose :global(ul), .prose :global(ol) {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
  }

  .prose :global(li) {
    margin-bottom: 0.25rem;
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: 0.88rem;
  }

  .prose :global(th), .prose :global(td) {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    text-align: left;
  }

  .prose :global(th) {
    background: var(--bg-secondary);
    font-weight: 600;
    color: var(--text-primary);
  }

  .prose :global(a) {
    color: var(--accent);
    text-decoration: none;
  }

  .prose :global(a:hover) {
    text-decoration: underline;
  }

  .prose :global(strong) {
    color: var(--text-primary);
  }

  .prose :global(blockquote) {
    border-left: 3px solid var(--accent);
    padding: 0.5rem 1rem;
    margin: 1rem 0;
    background: rgba(249, 115, 22, 0.05);
    border-radius: 0 4px 4px 0;
  }

  /* Pagination */
  .docs-pagination {
    display: flex;
    justify-content: space-between;
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  .pagination-link {
    display: flex;
    flex-direction: column;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.15s;
    max-width: 45%;
  }

  .pagination-link:hover {
    border-color: var(--accent);
    background: var(--bg-secondary);
  }

  .pagination-link.next {
    text-align: right;
  }

  .pagination-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .pagination-title {
    font-size: 0.9rem;
    color: var(--accent);
    font-weight: 500;
  }

  /* Table of Contents */
  .docs-toc {
    position: sticky;
    top: 5rem;
    height: calc(100vh - 5rem);
    overflow-y: auto;
    padding: 1.5rem 1rem;
    border-left: 1px solid var(--border);
  }

  .toc-heading {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-list li {
    margin-bottom: 0.25rem;
  }

  .toc-indent {
    padding-left: 0.75rem;
  }

  .toc-link {
    font-size: 0.78rem;
    color: var(--text-muted);
    text-decoration: none;
    display: block;
    padding: 0.15rem 0;
    transition: color 0.15s;
  }

  .toc-link:hover {
    color: var(--accent);
  }

  /* Mobile sidebar toggle */
  .sidebar-toggle {
    display: none;
    position: fixed;
    bottom: 1.5rem;
    left: 1.5rem;
    z-index: 50;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    border: none;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  @media (max-width: 1024px) {
    .docs-toc {
      display: none;
    }
    .docs-wrapper {
      grid-template-columns: 240px 1fr;
    }
  }

  @media (max-width: 768px) {
    .docs-wrapper {
      grid-template-columns: 1fr;
    }

    .docs-sidebar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      z-index: 60;
      background: var(--bg-primary);
      border-right: 1px solid var(--border);
      padding-top: 4rem;
    }

    .docs-sidebar.open {
      display: block;
    }

    .docs-content {
      padding: 1rem;
    }

    .sidebar-toggle {
      display: flex;
    }
  }
</style>

<script>
  const toggle = document.getElementById('sidebar-toggle')
  const sidebar = document.getElementById('docs-sidebar')
  if (toggle && sidebar) {
    toggle.addEventListener('click', () => {
      const isOpen = sidebar.classList.toggle('open')
      toggle.setAttribute('aria-expanded', String(isOpen))
    })
    // Close on outside click
    document.addEventListener('click', (e) => {
      if (sidebar.classList.contains('open') &&
          !sidebar.contains(e.target as Node) &&
          !toggle.contains(e.target as Node)) {
        sidebar.classList.remove('open')
        toggle.setAttribute('aria-expanded', 'false')
      }
    })
  }
</script>
